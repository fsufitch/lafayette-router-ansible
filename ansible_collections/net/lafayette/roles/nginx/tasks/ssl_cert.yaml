---
- name: Should we be using autogenerated SSL cert/key?
  when: not ((nginx_ssl_cert | default("")) and (nginx_ssl_key | default("")))
  block:
    - name: Create autogen-ssl directory
      ansible.builtin.file:
        path: "{{ nginx_dir }}/autogen-ssl"
        state: directory
        mode: ug+rwx,o-rwx
        owner: root
        group: root

    - name: Set autogen path facts
      ansible.builtin.set_fact:
        nginx_ssl_autogen_cert: "{{ nginx_dir }}/autogen-ssl/lafayette.crt"
        nginx_ssl_autogen_key: "{{ nginx_dir }}/autogen-ssl/lafayette.key"

    - name: Check if autogenerated keys already exist
      loop:
        - "{{ nginx_ssl_autogen_cert }}"
        - "{{ nginx_ssl_autogen_key }}"
      ansible.builtin.stat:
        path: "{{ item }}"
      register: ssl_files_status

    # See: https://docs.ansible.com/ansible/latest/collections/community/crypto/docsite/guide_selfsigned.html

    - name: Create private key
      when: ssl_files_status is not defined or ssl_files_status.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
      community.crypto.openssl_privatekey:
        path: "{{ nginx_ssl_autogen_key }}"
        type: RSA
        size: 4096
      notify: "net.lafayette.nginx :: SSL updated"

    - name: Generate self-signed SSL cert/key
      when: ssl_files_status is not defined or ssl_files_status.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
      community.crypto.x509_certificate:
        path: "{{ nginx_ssl_autogen_cert }}"
        privatekey_path: "{{ nginx_ssl_autogen_key }}"
        provider: selfsigned
      notify: "net.lafayette.nginx :: SSL updated"

    - name: Register the autogenerated SSL cert/key
      ansible.builtin.set_fact:
        nginx_ssl_cert: "{{ nginx_ssl_autogen_cert }}"
        nginx_ssl_key: "{{ nginx_ssl_autogen_key }}"
      notify: "net.lafayette.nginx :: SSL self-signed"

- name: Check if SSL cert/key files exist
  loop:
    - "{{ nginx_ssl_cert }}"
    - "{{ nginx_ssl_key }}"
  ansible.builtin.stat:
    path: "{{ item }}"
  register: result
  failed_when: not ((nginx_ssl_cert | default("")) and (nginx_ssl_key | default(""))) or not (result.stat.exists and (result.stat.isreg or result.stat.islnk))

- name: Calculate fingerprint
  ansible.builtin.command:
    cmd: "openssl x509 -in {{ nginx_ssl_cert }} -noout -fingerprint"
  register: ssl_fingerprint
  changed_when: false

- name: Record SSL fingerprint, for change detection
  ansible.builtin.copy:
    content: "{{ ssl_fingerprint.stdout }}\n"
    dest: "{{ nginx_dir }}/ssl-fingerprint"
    owner: root
    group: root
    mode: ug+rw,o-rwx
  notify: "net.lafayette.nginx :: SSL updated"
