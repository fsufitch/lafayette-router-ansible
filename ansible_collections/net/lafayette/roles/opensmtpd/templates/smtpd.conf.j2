# Generated by Ansible - OpenSMTPD relay for printer scan-to-email

table ses_secrets file:/opt/smtpd_secrets/ses_secrets
{% if opensmtpd_printer_auth_enabled -%}
table printer_secrets file:/opt/smtpd_secrets/printer_secrets
{% endif -%}
{% if opensmtpd_allowed_srcs | length > 0 -%}
table allowed_srcs { {{ opensmtpd_allowed_srcs | join(', ') }} }
{% endif %}

{% if opensmtpd_pki_cert | length > 0 and opensmtpd_pki_key | length > 0 -%}
pki {{ opensmtpd_pki_name }} cert "{{ opensmtpd_pki_cert }}"
pki {{ opensmtpd_pki_name }} key "{{ opensmtpd_pki_key }}"
{% endif %}

{% for addr in opensmtpd_listen_addrs %}

listen on {{ addr }} port {{ opensmtpd_submission_port }}
    {%- if opensmtpd_pki_cert | length > 0 and opensmtpd_pki_key | length > 0 -%} 
        {%- if opensmtpd_require_starttls %} tls-require {% else %} tls {% endif -%}
        pki {{ opensmtpd_pki_name }}
    {%- endif -%}
    {%- if opensmtpd_printer_auth_enabled -%} 
        {{' '}}auth <printer_secrets>
    {%- endif %}
{% endfor %}

action "relay_ses" relay host smtp+tls://ses@{{ opensmtpd_ses_smtp_host }}:{{ opensmtpd_ses_smtp_port }} auth <ses_secrets>{% if opensmtpd_envelope_mail_from | length > 0 %} mail-from "{{ opensmtpd_envelope_mail_from }}"{% endif %}

{% if opensmtpd_printer_auth_enabled -%}
match from auth for any action "relay_ses"
{% endif -%}
{% if opensmtpd_allowed_srcs | length > 0 -%}
match from src <allowed_srcs> for any action "relay_ses"
{% endif %}
match from any reject
